name: Push Notification with Claude Summary

on:
  push:
    branches:
      - main

jobs:
  summarize-and-notify:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å…¨å±¥æ­´ã‚’å–å¾—ã—ã¦å·®åˆ†ã‚’æ­£ç¢ºã«å–å¾—

    #   - name: Get commit info
    #     id: commit_info
    #     run: |
    #       # ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—
    #       COMMIT_MESSAGE=$(git log -1 --pretty=format:"%s")
    #       echo "commit_message=$COMMIT_MESSAGE" >> $GITHUB_OUTPUT
          
    #       # ã‚³ãƒŸãƒƒãƒˆãƒãƒƒã‚·ãƒ¥ã‚’å–å¾—
    #       COMMIT_SHA=$(git rev-parse --short HEAD)
    #       echo "commit_sha=$COMMIT_SHA" >> $GITHUB_OUTPUT
          
    #       # å·®åˆ†ã‚’å–å¾—
    #       echo "diff<<EOF" >> $GITHUB_OUTPUT
    #       git diff HEAD^ HEAD >> $GITHUB_OUTPUT
    #       echo "EOF" >> $GITHUB_OUTPUT

    #   - name: Run Claude analysis
    #     id: claude
    #     uses: anthropics/claude-code-base-action@beta
    #     with:
    #       anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
    #       prompt: |
    #         ã“ã®ã‚³ãƒŸãƒƒãƒˆã«ã‚ˆã‚‹å¤‰æ›´ã‚’ç°¡æ½”ã«è¦ç´„ã—ã¦ãã ã•ã„ã€‚
            
    #         ä»¥ä¸‹ã®ç‚¹ã«æ³¨æ„ã—ã¦ãã ã•ã„ï¼š
    #         - ã€Œã‚³ãƒŸãƒƒãƒˆ XXX ã®å¤‰æ›´å†…å®¹è¦ç´„:ã€ã®ã‚ˆã†ãªã‚¿ã‚¤ãƒˆãƒ«ã¯ä¸è¦ã§ã™
    #         - å¤‰æ›´è¡Œæ•°ï¼ˆXXè¡Œè¿½åŠ ã€XXè¡Œå‰Šé™¤ï¼‰ã®æƒ…å ±ã¯ä¸è¦ã§ã™
    #         - å®Ÿéš›ã®æ©Ÿèƒ½ã‚„å‹•ä½œã®å¤‰æ›´ã«ç„¦ç‚¹ã‚’å½“ã¦ã¦ãã ã•ã„
    #         - æŠ€è¡“çš„ãªå¤‰æ›´ã®æ„å›³ã‚„åŠ¹æœã‚’èª¬æ˜ã—ã¦ãã ã•ã„
    #         - ç®‡æ¡æ›¸ãã§ç°¡æ½”ã«è¨˜è¿°ã—ã¦ãã ã•ã„
            
    #         ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: ${{ steps.commit_info.outputs.commit_message }}
            
    #         å¤‰æ›´å†…å®¹:
    #         ```diff
    #         ${{ steps.commit_info.outputs.diff }}
    #         ```

    #   - name: Extract Claude response
    #     id: extract_response
    #     if: steps.claude.outputs.conclusion == 'success'
    #     uses: actions/github-script@v7
    #     with:
    #       script: |
    #         const fs = require('fs');
    #         const executionFile = '${{ steps.claude.outputs.execution_file }}';
            
    #         try {
    #           const fileContent = fs.readFileSync(executionFile, 'utf8');
    #           const executionLog = JSON.parse(fileContent);
              
    #           // é…åˆ—å½¢å¼ã®ãƒ­ã‚°ã‹ã‚‰çµæœã‚’æ¢ã™
    #           const resultEntry = executionLog.find(entry => entry.type === 'result' && entry.subtype === 'success');
              
    #           if (resultEntry && resultEntry.result) {
    #             // resultãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‹ã‚‰è¦ç´„ã‚’å–å¾—
    #             const summary = resultEntry.result;
                
    #             // Slackç”¨ã«æ”¹è¡Œã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
    #             const escapedSummary = summary.replace(/\n/g, '\\n');
    #             core.setOutput('summary', escapedSummary);
    #           } else {
    #             // resultãŒãªã„å ´åˆã¯æœ€å¾Œã®assistantãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ¢ã™
    #             const assistantEntries = executionLog.filter(entry => 
    #               entry.type === 'assistant' && 
    #               entry.message?.role === 'assistant' &&
    #               entry.message?.content
    #             );
                
    #             if (assistantEntries.length > 0) {
    #               const lastAssistant = assistantEntries[assistantEntries.length - 1];
    #               const content = lastAssistant.message.content;
                  
    #               let summary = '';
    #               if (Array.isArray(content)) {
    #                 // tool_useã§ã¯ãªãtextã‚’æ¢ã™
    #                 const textContent = content.find(c => c.type === 'text');
    #                 if (textContent) {
    #                   summary = textContent.text;
    #                 }
    #               } else if (typeof content === 'string') {
    #                 summary = content;
    #               }
                  
    #               if (summary) {
    #                 const escapedSummary = summary.replace(/\n/g, '\\n');
    #                 core.setOutput('summary', escapedSummary);
    #               } else {
    #                 core.setOutput('summary', 'è¦ç´„ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆãƒ†ã‚­ã‚¹ãƒˆã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼‰');
    #               }
    #             } else {
    #               core.setOutput('summary', 'è¦ç´„ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼‰');
    #             }
    #           }
    #         } catch (error) {
    #           console.error('Error processing Claude response:', error);
    #           core.setOutput('summary', `è¦ç´„ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
    #         }

    #   - name: Send to Slack
    #     env:
    #       SLACK_URL: ${{ secrets.SLACK_URL }}
    #     run: |
    #       # Slacké€šçŸ¥ã®ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’ä½œæˆ
    #       curl -X POST $SLACK_URL \
    #         -H 'Content-type: application/json' \
    #         -d "{
    #           \"text\": \"ğŸš€ mainãƒ–ãƒ©ãƒ³ãƒã«æ–°ã—ã„ãƒ—ãƒƒã‚·ãƒ¥ãŒã‚ã‚Šã¾ã—ãŸ\",
    #           \"blocks\": [
    #             {
    #               \"type\": \"header\",
    #               \"text\": {
    #                 \"type\": \"plain_text\",
    #                 \"text\": \"ğŸ“ ã‚³ãƒ¼ãƒ‰å¤‰æ›´é€šçŸ¥\"
    #               }
    #             },
    #             {
    #               \"type\": \"section\",
    #               \"fields\": [
    #                 {
    #                   \"type\": \"mrkdwn\",
    #                   \"text\": \"*ãƒªãƒã‚¸ãƒˆãƒª:*\n${{ github.repository }}\"
    #                 },
    #                 {
    #                   \"type\": \"mrkdwn\",
    #                   \"text\": \"*ã‚³ãƒŸãƒƒãƒˆ:*\n<${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}|${{ steps.commit_info.outputs.commit_sha }}>\"
    #                 }
    #               ]
    #             },
    #             {
    #               \"type\": \"section\",
    #               \"text\": {
    #                 \"type\": \"mrkdwn\",
    #                 \"text\": \"*ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:*\n${{ steps.commit_info.outputs.commit_message }}\"
    #               }
    #             },
    #             {
    #               \"type\": \"divider\"
    #             },
    #             {
    #               \"type\": \"section\",
    #               \"text\": {
    #                 \"type\": \"mrkdwn\",
    #                 \"text\": \"*ğŸ¤– Claudeã«ã‚ˆã‚‹å¤‰æ›´å†…å®¹ã®è¦ç´„:*\n${{ steps.extract_response.outputs.summary }}\"
    #               }
    #             },
    #             {
    #               \"type\": \"section\",
    #               \"text\": {
    #                 \"type\": \"mrkdwn\",
    #                 \"text\": \"*å®Ÿè¡Œè€…:*\n${{ github.actor }}\"
    #               }
    #             }
    #           ]
    #         }"